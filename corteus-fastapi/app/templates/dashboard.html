<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" href="{{ url_for('static', path='images/IconeLogo.png') }}" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'corteus': {
                            'primary': '#ff4b4b',
                            'secondary': '#ff7b00',
                            'dark': '#18191a',
                            'gray': '#23272f',
                            'light': '#f8fafc'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-white font-inter min-h-screen">
    <!-- Navigation -->
    <nav class="bg-corteus-gray border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center space-x-2 text-corteus-primary hover:text-corteus-secondary transition-colors">
                        <i class="fas fa-arrow-left"></i>
                        <span>Voltar ao Site</span>
                    </a>
                </div>
                <div class="text-sm text-gray-400 flex items-center space-x-4">
                    <i class="fas fa-chart-bar mr-2"></i>Analytics Dashboard
                    <div class="bg-green-500/20 px-3 py-1 rounded-full text-green-400 text-xs">
                        <i class="fas fa-circle text-xs mr-1"></i>Live
                    </div>
                </div>
                <div class="w-20"></div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="bg-gradient-to-br from-corteus-primary via-corteus-secondary to-orange-600 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">
                        <i class="fas fa-chart-line mr-3"></i>Analytics Dashboard
                    </h1>
                    <p class="text-lg text-white/90">Insights avançados sobre o comportamento dos usuários e performance da aplicação</p>
                </div>
                <div class="text-right">
                    <div class="text-white/80 text-sm">Última atualização</div>
                    <div class="text-white font-medium" id="lastUpdate">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Filtros -->
        <div class="bg-corteus-gray rounded-2xl p-6 mb-8 border border-gray-700/50">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-calendar text-corteus-primary"></i>
                    <label class="text-gray-300 font-medium">Período:</label>
                </div>
                <input type="date" id="startDate" class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-corteus-primary">
                <span class="text-gray-400">até</span>
                <input type="date" id="endDate" class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-corteus-primary">
                
                <div class="flex space-x-2">
                    <button onclick="loadData()" class="bg-corteus-primary hover:bg-corteus-primary/80 px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-sync mr-2"></i>Atualizar
                    </button>
                    <button onclick="setToday()" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg font-medium transition-colors text-sm">Hoje</button>
                    <button onclick="setWeek()" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg font-medium transition-colors text-sm">7 dias</button>
                    <button onclick="setMonth()" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg font-medium transition-colors text-sm">30 dias</button>
                </div>
                
                <div class="ml-auto flex space-x-3">
                    <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-trash mr-2"></i>Limpar Dados
                    </button>
                    <button onclick="exportData()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-600 border-t-corteus-primary mb-4"></div>
            <p class="text-gray-400">Carregando insights...</p>
        </div>

        <!-- Error State -->
        <div id="error-message" class="bg-red-900/20 border border-red-700 text-red-400 px-6 py-4 rounded-lg mb-8 hidden">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span id="error-text">Erro ao carregar dados</span>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" class="hidden space-y-8">
            <!-- KPI Cards Row 1 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Views -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50 hover:border-corteus-primary/50 transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Total de Visualizações</p>
                            <p class="text-3xl font-bold text-white mt-1" id="totalViews">-</p>
                            <p class="text-sm text-green-400 mt-1">
                                <i class="fas fa-arrow-up mr-1"></i>
                                <span id="viewsGrowth">-</span>
                            </p>
                        </div>
                        <div class="bg-corteus-primary/20 p-3 rounded-xl">
                            <i class="fas fa-eye text-2xl text-corteus-primary"></i>
                        </div>
                    </div>
                </div>

                <!-- Unique Users -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50 hover:border-blue-500/50 transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Usuários Únicos</p>
                            <p class="text-3xl font-bold text-white mt-1" id="uniqueUsers">-</p>
                            <p class="text-sm text-blue-400 mt-1">
                                <i class="fas fa-user-check mr-1"></i>
                                <span id="uniqueUsersInfo">únicos no período</span>
                            </p>
                        </div>
                        <div class="bg-blue-500/20 p-3 rounded-xl">
                            <i class="fas fa-users text-2xl text-blue-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Active Users Now -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50 hover:border-orange-500/50 transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Usuários Ativos Agora</p>
                            <p class="text-3xl font-bold text-white mt-1" id="activeUsersNow">-</p>
                            <p class="text-sm text-orange-400 mt-1">
                                <i class="fas fa-circle text-xs mr-1 animate-pulse"></i>
                                <span id="lastActiveUpdate">Atualizando...</span>
                            </p>
                        </div>
                        <div class="bg-orange-500/20 p-3 rounded-xl">
                            <i class="fas fa-broadcast-tower text-2xl text-orange-400"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards Row 2 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Avg Time on Page -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Tempo Médio na Página</p>
                            <p class="text-2xl font-bold text-white mt-1" id="avgTimeOnPage">-</p>
                        </div>
                        <div class="bg-purple-500/20 p-3 rounded-xl">
                            <i class="fas fa-clock text-xl text-purple-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Total Interactions -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Interações Totais</p>
                            <p class="text-2xl font-bold text-white mt-1" id="totalInteractions">-</p>
                        </div>
                        <div class="bg-pink-500/20 p-3 rounded-xl">
                            <i class="fas fa-mouse-pointer text-xl text-pink-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Peak Hour -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Horário de Pico</p>
                            <p class="text-2xl font-bold text-white mt-1" id="peakHour">-</p>
                        </div>
                        <div class="bg-orange-500/20 p-3 rounded-xl">
                            <i class="fas fa-fire text-xl text-orange-400"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Management Section -->
            <div class="bg-gradient-to-br from-red-900/20 to-orange-900/20 rounded-2xl p-6 border border-red-500/30 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-cogs text-red-400 mr-3"></i>
                        Administração do Log
                    </h3>
                    <button onclick="loadLogInfo()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-colors">
                        <i class="fas fa-refresh mr-2"></i>Atualizar Info
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- File Size -->
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <p class="text-gray-400 text-sm">Tamanho do Arquivo</p>
                        <p class="text-xl font-bold text-white" id="logFileSize">- KB</p>
                    </div>
                    
                    <!-- Event Count -->
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <p class="text-gray-400 text-sm">Total de Eventos</p>
                        <p class="text-xl font-bold text-white" id="logEventCount">-</p>
                    </div>
                    
                    <!-- Oldest Event -->
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <p class="text-gray-400 text-sm">Evento Mais Antigo</p>
                        <p class="text-sm font-medium text-white" id="logOldestEvent">-</p>
                    </div>
                    
                    <!-- Compaction Status -->
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <p class="text-gray-400 text-sm">Status</p>
                        <p class="text-sm font-medium" id="logCompactionStatus">
                            <span class="text-green-400">✓ OK</span>
                        </p>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-3">
                    <button onclick="compactLog()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm transition-colors">
                        <i class="fas fa-compress-alt mr-2"></i>Compactar Log
                    </button>
                    
                    <button onclick="showEventTypes()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-colors">
                        <i class="fas fa-list mr-2"></i>Ver Tipos de Evento
                    </button>
                    
                    <button onclick="clearAllData()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">
                        <i class="fas fa-trash mr-2"></i>Limpar Todos os Dados
                    </button>
                </div>
                
                <!-- Results Area -->
                <div id="logManagementResults" class="mt-4 hidden">
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <pre id="logManagementOutput" class="text-sm text-gray-300 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Daily Views Chart -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-chart-line text-corteus-primary mr-3"></i>
                            Visualizações por Dia
                        </h3>
                        <div class="text-sm text-gray-400">Últimos 30 dias</div>
                    </div>
                    <div class="h-80">
                        <canvas id="dailyViewsChart"></canvas>
                    </div>
                </div>

                <!-- Hourly Activity Chart -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-clock text-blue-400 mr-3"></i>
                            Atividade por Hora
                        </h3>
                        <div class="text-sm text-gray-400">24h</div>
                    </div>
                    <div class="h-80">
                        <canvas id="hourlyActivityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Device Analytics -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-mobile-alt text-green-400 mr-3"></i>
                        Dispositivos
                    </h3>
                    <div class="h-64">
                        <canvas id="deviceChart"></canvas>
                    </div>
                </div>

                <!-- Browser Analytics -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-globe text-purple-400 mr-3"></i>
                        Navegadores
                    </h3>
                    <div class="h-64">
                        <canvas id="browserChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tables Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Top Pages -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-file-alt text-corteus-primary mr-3"></i>
                        Páginas Mais Visitadas
                    </h3>
                    <div id="topPagesList" class="space-y-3">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                </div>

                <!-- Top Interactions -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-mouse-pointer text-orange-400 mr-3"></i>
                        Botões Mais Clicados
                    </h3>
                    <div id="topButtonsList" class="space-y-3">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Real-time metrics -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Performance Metrics -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-tachometer-alt text-cyan-400 mr-3"></i>
                        Performance
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Total de Eventos</span>
                            <span class="text-white font-bold" id="totalEvents">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Eventos por Usuário</span>
                            <span class="text-white font-bold" id="eventsPerUser">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Sessões Ativas</span>
                            <span class="text-white font-bold" id="activeSessions">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Sessões por Usuário</span>
                            <span class="text-white font-bold" id="sessionsPerUser">-</span>
                        </div>
                    </div>
                </div>

                <!-- Engagement Metrics -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-heart text-pink-400 mr-3"></i>
                        Engajamento
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Formulários Enviados</span>
                            <span class="text-white font-bold" id="formSubmissions">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Cliques em Ajuda</span>
                            <span class="text-white font-bold" id="helpClicks">-</span>
                        </div>
                    </div>
                </div>

                <!-- Growth Metrics -->
                <div class="bg-gradient-to-br from-corteus-gray to-gray-800 rounded-2xl p-6 border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-chart-line text-emerald-400 mr-3"></i>
                        Crescimento
                    </h3>
                    <div class="space-y-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-emerald-400" id="growthRate">+0%</div>
                            <div class="text-gray-400 text-sm">vs período anterior</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentData = null;
        let charts = {};
        let activeUsersInterval = null;

        // Função global para atualizar contagem de usuários ativos (chamada pelo analytics.js)
        window.updateActiveUsersCount = function(count) {
            document.getElementById('activeUsersNow').textContent = count;
            document.getElementById('lastActiveUpdate').textContent = 'Atualizado agora';
        };

        // Função para buscar usuários ativos
        async function updateActiveUsers() {
            try {
                // Indicar que está atualizando
                document.getElementById('lastActiveUpdate').textContent = 'atualizando...';
                
                const response = await fetch('/active-users');
                if (response.ok) {
                    const data = await response.json();
                    const count = data.active_users_now || 0;
                    
                    document.getElementById('activeUsersNow').textContent = count;
                    document.getElementById('lastActiveUpdate').textContent = 'agora mesmo';
                    
                    // Adicionar animação se houver mudança
                    const element = document.getElementById('activeUsersNow');
                    element.classList.add('animate-pulse');
                    setTimeout(() => element.classList.remove('animate-pulse'), 500);
                } else {
                    document.getElementById('lastActiveUpdate').textContent = 'erro na consulta';
                }
            } catch (error) {
                console.debug('Erro ao buscar usuários ativos:', error);
                document.getElementById('lastActiveUpdate').textContent = 'erro na atualização';
            }
        }

        // Iniciar monitoramento de usuários ativos
        function startActiveUsersMonitoring() {
            // Buscar imediatamente
            updateActiveUsers();
            
            // Atualizar a cada 30 segundos
            if (activeUsersInterval) {
                clearInterval(activeUsersInterval);
            }
            
            activeUsersInterval = setInterval(updateActiveUsers, 30000);
        }

        // Parar monitoramento quando sair da página
        window.addEventListener('beforeunload', () => {
            if (activeUsersInterval) {
                clearInterval(activeUsersInterval);
            }
        });

        // Função principal para carregar dados
        async function loadData() {
            showLoading();
            hideError();
            
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                console.log('Carregando dados para o período:', startDate, 'até', endDate);
                
                let url = '/analytics-data';
                
                if (startDate || endDate) {
                    const params = new URLSearchParams();
                    if (startDate) params.append('start_date', startDate);
                    if (endDate) params.append('end_date', endDate);
                    url += '?' + params.toString();
                }
                
                console.log('URL da requisição:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Erro HTTP: ' + response.status);
                }
                
                const data = await response.json();
                
                // Verificar se os dados têm a estrutura esperada
                if (!data || typeof data !== 'object') {
                    throw new Error('Dados inválidos recebidos da API');
                }
                
                // Garantir estrutura mínima dos dados
                const safeData = {
                    total_views: data.total_views || 0,
                    unique_users: data.unique_users || 0,
                    top_pages: data.top_pages || [],
                    daily_views: data.daily_views || [],
                    user_engagement: data.user_engagement || {},
                    performance_metrics: data.performance_metrics || {},
                    device_analytics: data.device_analytics || {},
                    time_analytics: data.time_analytics || {},
                    interaction_analytics: data.interaction_analytics || {}
                };
                
                currentData = safeData;
                
                // Atualizar último update
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('pt-BR');
                
                // Atualizar dashboard com tratamento de erro
                try {
                    updateKPIs(safeData);
                    updateCharts(safeData);
                    updateTables(safeData);
                    updateMetrics(safeData);
                } catch (updateError) {
                    console.error('Erro ao atualizar dashboard:', updateError);
                    showError('Erro ao processar dados: ' + updateError.message);
                    return;
                }
                
                hideLoading();
                showDashboard();
                
            } catch (error) {
                console.error('Erro:', error);
                hideLoading();
                showError('Erro ao carregar dados: ' + error.message);
            }
        }

        // Atualizar KPIs
        function updateKPIs(data) {
            // Função auxiliar para verificar e formatar valores
            const safeValue = (value, defaultValue = 0) => value !== undefined && value !== null ? value : defaultValue;
            const safeFixed = (value, decimals = 1, defaultValue = 0) => {
                const val = safeValue(value, defaultValue);
                return typeof val === 'number' ? val.toFixed(decimals) : defaultValue.toFixed(decimals);
            };
            
            document.getElementById('totalViews').textContent = safeValue(data.total_views).toLocaleString('pt-BR');
            document.getElementById('uniqueUsers').textContent = safeValue(data.unique_users).toLocaleString('pt-BR');
            document.getElementById('avgTimeOnPage').textContent = formatTime(safeValue(data.user_engagement?.avg_time_on_page));
            document.getElementById('totalInteractions').textContent = safeValue(data.user_engagement?.total_interactions).toLocaleString('pt-BR');
            document.getElementById('peakHour').textContent = safeValue(data.time_analytics?.peak_hour, 0) + 'h';
            // Não sobrescrever activeUsersNow aqui - será atualizado pelo sistema em tempo real
            document.getElementById('viewsGrowth').textContent = '+0%'; // Placeholder
        }

        // Atualizar métricas adicionais
        function updateMetrics(data) {
            // Função auxiliar para verificar e formatar valores
            const safeValue = (value, defaultValue = 0) => value !== undefined && value !== null ? value : defaultValue;
            const safeFixed = (value, decimals = 1, defaultValue = 0) => {
                const val = safeValue(value, defaultValue);
                return typeof val === 'number' ? val.toFixed(decimals) : defaultValue.toFixed(decimals);
            };
            
            document.getElementById('totalEvents').textContent = safeValue(data.performance_metrics?.total_events).toLocaleString('pt-BR');
            document.getElementById('eventsPerUser').textContent = safeFixed(data.performance_metrics?.events_per_user);
            document.getElementById('activeSessions').textContent = safeValue(data.performance_metrics?.active_sessions).toLocaleString('pt-BR');
            document.getElementById('sessionsPerUser').textContent = safeFixed(data.performance_metrics?.avg_sessions_per_user);
            document.getElementById('formSubmissions').textContent = safeValue(data.interaction_analytics?.form_completions).toLocaleString('pt-BR');
            document.getElementById('helpClicks').textContent = safeValue(data.interaction_analytics?.help_clicks).toLocaleString('pt-BR');
        }

        // Atualizar gráficos
        function updateCharts(data) {
            updateDailyViewsChart(data.daily_views || []);
            updateHourlyActivityChart(data.time_analytics?.hourly_activity || []);
            updateDeviceChart(data.device_analytics?.devices || []);
            updateBrowserChart(data.device_analytics?.browsers || []);
        }

        // Atualizar tabelas com validação
        function updateTables(data) {
            try {
                updateTopPagesList(data.top_pages || []);
                updateTopButtonsList(data.interaction_analytics?.top_buttons || []);
            } catch (error) {
                console.error('Erro ao atualizar tabelas:', error);
            }
        }

        function updateDailyViewsChart(data) {
            const ctx = document.getElementById('dailyViewsChart').getContext('2d');
            
            if (charts.dailyViews) {
                charts.dailyViews.destroy();
            }
            
            // Se não há dados, criar dados vazios para evitar erros
            const chartData = data && Array.isArray(data) && data.length > 0 ? data : [
                { date: new Date().toISOString().split('T')[0], views: 0 }
            ];
            
            charts.dailyViews = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(item => {
                        // Processar data como local para evitar problemas de fuso horário
                        const dateStr = item.date || new Date().toISOString().split('T')[0];
                        const [year, month, day] = dateStr.split('-');
                        const date = new Date(year, month - 1, day); // Criar data local
                        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Visualizações',
                        data: chartData.map(item => item.views || 0),
                        borderColor: '#ff4b4b',
                        backgroundColor: 'rgba(255, 75, 75, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ff4b4b',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: '#ff4b4b',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(156, 163, 175, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateHourlyActivityChart(data) {
            const ctx = document.getElementById('hourlyActivityChart').getContext('2d');
            
            if (charts.hourlyActivity) {
                charts.hourlyActivity.destroy();
            }
            
            // Criar array com todas as horas (0-23)
            const safeData = data && Array.isArray(data) ? data : [];
            const hourlyData = Array.from({ length: 24 }, (_, i) => {
                const hourData = safeData.find(item => item.hour === i);
                return hourData ? (hourData.activity || 0) : 0;
            });
            
            charts.hourlyActivity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({ length: 24 }, (_, i) => i + 'h'),
                    datasets: [{
                        label: 'Atividade',
                        data: hourlyData,
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(156, 163, 175, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateDeviceChart(data) {
            const ctx = document.getElementById('deviceChart').getContext('2d');
            
            if (charts.device) {
                charts.device.destroy();
            }
            
            const colors = ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
            const safeData = data && Array.isArray(data) && data.length > 0 ? data : [
                { type: 'Sem dados', count: 1 }
            ];
            
            charts.device = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: safeData.map(item => item.type || 'Sem dados'),
                    datasets: [{
                        data: safeData.map(item => item.count || 0),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white', padding: 20 }
                        }
                    }
                }
            });
        }

        function updateBrowserChart(data) {
            const ctx = document.getElementById('browserChart').getContext('2d');
            
            if (charts.browser) {
                charts.browser.destroy();
            }
            
            const colors = ['#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'];
            const safeData = data && Array.isArray(data) && data.length > 0 ? data : [
                { browser: 'Sem dados', count: 1 }
            ];
            
            charts.browser = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: safeData.map(item => item.browser || 'Sem dados'),
                    datasets: [{
                        data: safeData.map(item => item.count || 0),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white', padding: 20 }
                        }
                    }
                }
            });
        }

        function updateTopPagesList(data) {
            const container = document.getElementById('topPagesList');
            if (!data || !Array.isArray(data)) {
                container.innerHTML = '<div class="text-gray-400 text-center p-4">Nenhum dado disponível</div>';
                return;
            }
            
            container.innerHTML = data.map((page, index) =>
                '<div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">' +
                    '<div class="flex items-center space-x-3">' +
                        '<div class="w-8 h-8 rounded-full bg-corteus-primary/20 flex items-center justify-center text-corteus-primary font-bold text-sm">' +
                            (index + 1) +
                        '</div>' +
                        '<span class="text-white font-medium">' + (page.page || '/') + '</span>' +
                    '</div>' +
                    '<div class="text-right">' +
                        '<div class="text-white font-bold">' + (page.views || page.count || 0).toLocaleString('pt-BR') + '</div>' +
                        '<div class="text-gray-400 text-sm">visualizações</div>' +
                    '</div>' +
                '</div>'
            ).join('');
        }

        function updateTopButtonsList(data) {
            const container = document.getElementById('topButtonsList');
            if (!data || !Array.isArray(data)) {
                container.innerHTML = '<div class="text-gray-400 text-center p-4">Nenhum dado disponível</div>';
                return;
            }
            
            container.innerHTML = data.map((button, index) =>
                '<div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">' +
                    '<div class="flex items-center space-x-3">' +
                        '<div class="w-8 h-8 rounded-full bg-orange-400/20 flex items-center justify-center text-orange-400 font-bold text-sm">' +
                            (index + 1) +
                        '</div>' +
                        '<span class="text-white font-medium">' + (button.button || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div class="text-right">' +
                        '<div class="text-white font-bold">' + (button.clicks || 0).toLocaleString('pt-BR') + '</div>' +
                        '<div class="text-gray-400 text-sm">cliques</div>' +
                    '</div>' +
                '</div>'
            ).join('');
        }

        function formatTime(seconds) {
            if (seconds < 60) return seconds.toFixed(0) + 's';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return minutes + 'm ' + remainingSeconds + 's';
        }

        function exportData() {
            if (!currentData) {
                alert('Nenhum dado para exportar. Carregue os dados primeiro.');
                return;
            }
            
            const dataStr = JSON.stringify(currentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'corteus-analytics-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (!confirm('⚠️ ATENÇÃO: Esta ação irá apagar TODOS os dados de analytics permanentemente.\\n\\nTem certeza que deseja continuar?')) {
                return;
            }
            
            if (!confirm('🚨 CONFIRMAÇÃO FINAL: Todos os dados serão perdidos para sempre.\\n\\nClique OK para confirmar:')) {
                return;
            }
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            
            fetch('/clear-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Dados limpos com sucesso!\\n\\nO dashboard será recarregado com dados zerados.');
                    
                    // Limpar dados locais
                    currentData = null;
                    
                    // Recarregar dados (agora vazios)
                    loadData();
                } else {
                    throw new Error(data.message || 'Erro ao limpar dados');
                }
            })
            .catch(error => {
                console.error('Erro ao limpar dados:', error);
                alert('❌ Erro ao limpar dados: ' + error.message);
                
                // Esconder loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
            });
        }

        function setToday() {
            const today = new Date();
            console.log('Data atual:', today);
            // Usar data local em vez de UTC para evitar problemas de fuso horário
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            
            console.log('Data formatada para hoje:', todayString);
            
            document.getElementById('startDate').value = todayString;
            document.getElementById('endDate').value = todayString;
        }

        function setWeek() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            // Função auxiliar para formatar data local
            const formatLocalDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatLocalDate(weekAgo);
            document.getElementById('endDate').value = formatLocalDate(today);
        }

        function setMonth() {
            const today = new Date();
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Função auxiliar para formatar data local
            const formatLocalDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatLocalDate(monthAgo);
            document.getElementById('endDate').value = formatLocalDate(today);
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('dashboard-content').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        // === Log Management Functions ===
        
        async function loadLogInfo() {
            try {
                const response = await fetch('/log-info');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Atualizar interface com validação
                    document.getElementById('logFileSize').textContent = `${data.file_size_kb || 0} KB`;
                    document.getElementById('logEventCount').textContent = (data.event_count || 0).toLocaleString('pt-BR');
                    
                    // Formatar data do evento mais antigo
                    if (data.oldest_event) {
                        const oldestDate = new Date(data.oldest_event);
                        document.getElementById('logOldestEvent').textContent = oldestDate.toLocaleDateString('pt-BR');
                    } else {
                        document.getElementById('logOldestEvent').textContent = 'Nenhum';
                    }
                    
                    // Status de compactação
                    const statusElement = document.getElementById('logCompactionStatus');
                    if (data.needs_compaction) {
                        statusElement.innerHTML = '<span class="text-yellow-400">⚠ Precisa compactar</span>';
                    } else {
                        statusElement.innerHTML = '<span class="text-green-400">✓ OK</span>';
                    }
                    
                    // Mostrar tipos de evento se disponível
                    if (data.event_types && Object.keys(data.event_types).length > 0) {
                        let eventTypesText = 'Tipos de evento:\n';
                        for (const [type, count] of Object.entries(data.event_types)) {
                            eventTypesText += `- ${type}: ${count}\n`;
                        }
                        showLogResult(eventTypesText, 'info');
                    }
                } else {
                    showLogResult('Erro ao carregar informações do log', 'error');
                }
            } catch (error) {
                showLogResult('Erro: ' + error.message, 'error');
            }
        }
        
        async function compactLog() {
            try {
                showLogResult('Iniciando compactação...', 'info');
                
                const response = await fetch('/compact', { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        const message = `Compactação concluída!
Original: ${result.original_count} eventos
Final: ${result.final_count} eventos
Removidos: ${result.removed_count} eventos
Taxa de compressão: ${result.compression_ratio}`;
                        showLogResult(message, 'success');
                        
                        // Recarregar informações do log
                        setTimeout(loadLogInfo, 1000);
                    } else {
                        showLogResult('Erro na compactação: ' + result.error, 'error');
                    }
                } else {
                    showLogResult('Erro HTTP na compactação', 'error');
                }
            } catch (error) {
                showLogResult('Erro: ' + error.message, 'error');
            }
        }
        
        async function showEventTypes() {
            try {
                const response = await fetch('/log-info');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.event_types && Object.keys(data.event_types).length > 0) {
                        let eventTypesText = 'TIPOS DE EVENTOS:\n\n';
                        const sortedTypes = Object.entries(data.event_types)
                            .sort((a, b) => b[1] - a[1]);
                        
                        for (const [type, count] of sortedTypes) {
                            const percentage = ((count / data.event_count) * 100).toFixed(1);
                            eventTypesText += `${type}: ${count} (${percentage}%)\n`;
                        }
                        
                        showLogResult(eventTypesText, 'info');
                    } else {
                        showLogResult('Nenhum tipo de evento encontrado', 'info');
                    }
                } else {
                    showLogResult('Erro ao carregar tipos de evento', 'error');
                }
            } catch (error) {
                showLogResult('Erro: ' + error.message, 'error');
            }
        }
        
        async function clearAllData() {
            const confirmed = confirm('⚠️ ATENÇÃO!\n\nIsso irá deletar TODOS os dados de analytics permanentemente!\n\nTem certeza que deseja continuar?');
            
            if (!confirmed) {
                return;
            }
            
            const doubleConfirm = confirm('🛑 ÚLTIMA CONFIRMAÇÃO!\n\nEsta ação NÃO pode ser desfeita!\n\nTodos os dados históricos serão perdidos!\n\nConfirma mesmo?');
            
            if (!doubleConfirm) {
                return;
            }
            
            try {
                showLogResult('Limpando todos os dados...', 'info');
                
                const response = await fetch('/clear-data', { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    showLogResult('✅ Todos os dados foram limpos com sucesso!', 'success');
                    
                    // Recarregar página após 2 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showLogResult('Erro ao limpar dados', 'error');
                }
            } catch (error) {
                showLogResult('Erro: ' + error.message, 'error');
            }
        }
        
        function showLogResult(message, type = 'info') {
            const resultsDiv = document.getElementById('logManagementResults');
            const outputPre = document.getElementById('logManagementOutput');
            
            // Mostrar resultado
            resultsDiv.classList.remove('hidden');
            outputPre.textContent = message;
            
            // Aplicar cor baseada no tipo
            outputPre.className = 'text-sm whitespace-pre-wrap ';
            switch (type) {
                case 'success':
                    outputPre.className += 'text-green-400';
                    break;
                case 'error':
                    outputPre.className += 'text-red-400';
                    break;
                case 'warning':
                    outputPre.className += 'text-yellow-400';
                    break;
                default:
                    outputPre.className += 'text-gray-300';
            }
            
            // Auto-hide após 10 segundos para mensagens de sucesso
            if (type === 'success') {
                setTimeout(() => {
                    resultsDiv.classList.add('hidden');
                }, 10000);
            }
        }

        // Carregar dados iniciais
        window.addEventListener('load', function() {
            setToday(); // Definir período padrão para hoje
            loadData();
            
            // Iniciar monitoramento de usuários ativos
            startActiveUsersMonitoring();
            
            // Carregar informações do log
            loadLogInfo();
            
            // Auto-refresh a cada 5 minutos
            setInterval(loadData, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
